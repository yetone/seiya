#!/usr/bin/env ruby

$:.unshift File.expand_path '.'
$:.unshift File.expand_path '../../lib', __FILE__
require 'optparse'

options = {}

OptionParser.new do |opts|
  opts.banner = 'Usage: seiya [options]'

  opts.on '-v', '--version', 'seiya version' do |v|
    options[:version] = v
  end

  opts.on '-tTask', '--task=Task', 'run a seiya task' do |t|
    options[:task] = t
  end

  opts.on '-aArg', '--argument=Arg', 'send argument to seiya task' do |a|
    options[:args] = [] unless options[:args]
    options[:args] << a
  end

  opts.on '-cTask', '--create=Task', 'create a seiya task' do |t|
    options[:create] = t
  end
end.parse!

def extend_load_path(path)
  Dir.foreach path do |f|
    unless %w(. ..).include? f
      if File.directory? File.join path, f
        new_path = File.join path, f
        extend_load_path new_path
      elsif f == 'tasks.rb'
        $:.unshift path
        break
      end
    end
  end
end
pwd = Dir.pwd
extend_load_path pwd

begin
  require 'tasks'
rescue
  raise 'No spiders!'
end

if options.key? :task
  Seiya.setup
  task_name = options[:task]
  begin
    task = Seiya.get_task task_name
  rescue NameError
    puts "No task named: #{task_name}"
    exit!
  end
  task.run
end

if options.key? :version
  puts Seiya::VERSION
end

if options.key? :create
  task_name = options[:create]
  Seiya.gen_task_file task_name
end
